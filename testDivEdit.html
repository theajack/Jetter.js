<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="keywords" content="validation,validate,css animation,js,jetter,jQuery,js library">  
    <meta name="description" content="js library for form operate and validate,select HTMLElement like jQuery">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta http-equiv="X-UA-Compatible" content="IE=8">

    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <title>test div eidt</title>
    <link rel="stylesheet" type="text/css" href="assets/css/index.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/base.min.css"/>
    <style>
    #test{
      margin:200px;
      
      word-break:break-word;
      /*word-wrap:nowrap;*/
      white-space: nowrap;
      border:1px solid #000;
      overflow:auto;
      width:200px;
      height:100px;
    }
    #a{
      width:200px;
      height:200px;
      position:absolute;
      top:0;
	  opacity:0;
    }
    #aClone{
      width:200px;
      height:200px;
      position:absolute;
      top:0;
      border:1px solid #f00;
    }
    #test > div{
      width:100%;
      height:15px;
    }
    </style>
  </head>
  <body>

    <div id="test" contenteditable="true" data-init="true">
      <div></div>
    </div>
      <div style="position:relative;height:200px">
          <div id="aClone" contenteditable="true" ></div>
          <textarea id="a" onkeydown="check(event)"></textarea>
      </div>

<br/>
<button onclick="alert(getFieldSelection(J.id('test')))">button_click</button>
    <textarea id="test1"></textarea>
    
<br/><input type="button" value="click" onclick="rangeTest()"/>
    <div id="showRange"></div>
    
    
<br/><div id="myDiv">
      删除这段文字哈哈</div>
     <button onclick="deleteChar()">删除文字</button>
    <script src="assets/js/jetQuery.js"></script>
    <script src="assets/js/jetter.js"></script>
    <script src="assets/js/tabIndent.js"></script>
    <script>
    
    var isMouseDown=false;
    var posDown={x:0,y:0};
    var posUp={x:0,y:0};
    var pos={x:0,y:0};
    var l1=0;
    var l2=0;
    var h=15;
    J.ready(function(){
      var rect=J.id("test").getBoundingClientRect();
      pos.x=rect.left;
      pos.y=rect.top;
      J.id("test").event({
        "onmousedown":function(event){
          d1(event);
        },"onmousemouse":function(event){
          d2(event);
        },"onmouseup":function(event){
          d3(event);
        },"onkeydown":function(event){
          checkkey(event);
        },"oninput":function(event){
          //checkinput();
        },"onmouseleave":function(event){
          //d4(event);
        },
      })
      
    });
    function d1(e){
      isMouseDown=true;
      posDown.x=e.clientX;
      posDown.y=e.clientY;
      l1=getLineIndex(e);
    }
    function d2(e){
    }
    function d3(e){
      isMouseDown=false;
      
      posUp.x=e.clientX;
      posUp.y=e.clientY;
      l2=getLineIndex(e);
      if(l2<l1){
        var i=l2;
        l2=l1;
        l1=i;
      }
    }
    
    function d4(e){
      if(onmousedown){
        J.id("test").focus();
        J.id("test").selection.setRangeAfter(last);
        l2=getLineIndex(e);
      }
    }
    function getLineIndex(e){
      return checkLine(Math.floor((e.clientY-J.id("test").getBoundingClientRect().top+J.id("test").scrollTop)/h));
    }
    function checkLine(line){
      var n=J.id("test").child().length;
      if(line>=n){
        return n-1;
      }else if(line<0){
        return 0;
      }else{
        return line;
      }
    }
    function checkkey(e){
      switch(e.keyCode){
        case 9:
        e.preventDefault();
        if(e.shiftKey===false){
          var childs=J.id("test").child();
          for(var i=l1;i<=l2;i++){
            childs[i].css("padding-left","+=10px");
          }
        }else{
          var childs=J.id("test").child();
          for(var i=l1;i<=l2;i++){
            if(parseInt(childs[i].css("padding-left").split("p")[0])>=10)
              childs[i].css("padding-left","-=10px");
          }
        };break;
        case 13:l1++;l2=l1;
      }
      if(e.keyCode===9){//tab
        
      }else if (e.keyCode===13){
        l1++;
        l2=l1;
      }
      /*if(e.keyCode===13){//huiche
        e.preventDefault();
        J.id("test").html(J.id("test").html()+"\n"+"aa");
      }
      if(e.keyCode===65){//a
        alert(window.getSelection().baseNode.nodeValue);
      }*/
    }
    function getRangeOffset(){
      var rect = getSelection().getRangeAt(0).getBoundingClientRect();
      var divrect = J.id("test").getBoundingClientRect();
      return {
        x:rect.left-divrect.left+J.id("test").scrollLeft,
        y:rect.top-divrect.top+J.id("test").scrollTop,
        h:rect.height,
        w:rect.width
      };
    }
    function checkinput(){
      
    }
    function check(e){
      e.preventDefault();
      J.id("aClone").text(J.id("a").val())
        /*if(e.keyCode===9){//tab
          if(e.shiftKey===false){
            e.preventDefault();
            J.id("test").findTag("div").css("margin-left","+=10px");
            alert(J.id("test").selectionStart);
          }else{
          
          }
        }
        if(e.keyCode===13){//huiche
          e.preventDefault();
          J.id("test").html(J.id("test").html()+"\n"+"aa");
        }
        if(e.keyCode===65){//a
          alert(window.getSelection().baseNode.nodeValue);
        }*/
    }
    function getFieldSelection(select_field)
    {
        word='';
        if (document.selection) {
            var sel = document.selection.createRange();
            if (sel.text.length > 0) {
                word = sel.text;
            }
        }
        else if (select_field.selectionStart || select_field.selectionStart == '0') {
            var startP = select_field.selectionStart;
            var endP = select_field.selectionEnd;
            if (startP != endP) {
                word = select_field.value.substring(startP, endP);
            }
        }
        return word;
    }
    
    function rangeTest(){
      var html;
      showRangeDiv=J.id("showRange");
      selection=document.getSelection();
      if(selection.rangeCount>0){
        html="选取了>"+selection.rangeCount+"<内容<br/>"
        for(var i=0;i<selection.rangeCount;i++){
          var range = selection.getRangeAt(i);
          html+="第"+(i+1)+"段内容为："+range+"<br/>";
        }
        showRangeDiv.html(html);
      }
    }
    function deleteChar(){
      var div=J.id("myDiv");
      var textNode=div.firstChild;//div.firstChild
      var range=document.createRange();
      range.setStart(textNode,1);
      range.setEnd(textNode,4);
      range.deleteContents();
      
    }
    </script>
    <!--<div id="jetInputWrapper">
      <div id="jetInputLittleWrapper" class=" large">
        <div id="jetInputContent">
        
        </div>
        <div id="jetInputBtnWrapper">
        <div id="jetInputOk" onclick="jet_inputOk()">
        <span class=" icon-circle no-border">
        <span class=" icon-part-ok1 rotate-45">
        </span><span class=" icon-part-ok2 rotate-45">
        </span></span></div><div id="jetInputCancel" onclick="jet_inputCancel()"><span class=" icon-circle no-border">
        <span class=" icon-part-x rotate-45"></span><span class=" icon-part-x rotate-045"></span></span></div></div></div></div>-->
  </body>
</html>
